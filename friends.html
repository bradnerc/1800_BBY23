<!DOCTYPE html>
<html>

<!--This may be abandoned in the future-->

<head>
    <meta charset="utf-8" />
    <title>Friends</title>
    <meta name="comp1800 boilerplate code" content="my bcit project" />
    <meta name="author" content="BCIT" />

    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />

    <!-- Google Icons (Material Design)-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

    <!-- Firebase 8 CDNs-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>


    <!-- Link to the api keys for your firebase project -->
    <script src="./scripts/firebaseAPI_TEAM23.js"></script>

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        #profile_icon {
            position: absolute;
            font-size: 60px;
            margin-top: 10%;
            right: 5%;
            color: black;
            text-decoration: none;
        }

        body {
            margin-bottom: 10%;
        }

        .heading {
            margin-top: 10vh;
        }

        #friends {
            display: grid;
            margin-top: 10%;
            margin-bottom: 10%;
            /* grid-template-columns: 20% 40% 20% 20%; */
        }

        .friend_request {
            display: grid;
            grid-template-columns: 20% 40% 20% 20%;
        }

        #invite {
            display: grid;
            margin-bottom: 10%;
        }

        .request {
            display: grid;
            grid-template-columns: 20% 80%;
        }
    </style>
</head>

<body>
    <script>
        $.get("nav.html", {}, function(response) {
            $("div#nav").append(response);
        });
    </script>

    <!------------------------------------>
    <!-- Your own HTML layout goes here -->
    <!------------------------------------>
    <div id="container" class="container">
        <header class="navbar justify-content-between bg-white fixed-top">
            <a class="material-icons" id="profile_icon" href="userprofile.html">account_circle</a>
        </header>
        <section class="heading">
            <h1>Friend Requests</h1>
        </section>
        <br>
        <h2>Incoming</h2>

        <div id="friends">
            <div class="friend_request">
                <span class="material-icons">account_circle</span>
                <h4>Euler</h4>
                <span class="material-icons">done</span>
                <span class="material-icons">close</span>
            </div>
            <div class="friend_request">
                <span class="material-icons">account_circle</span>
                <h4>Bernoulli</h4>
                <span class="material-icons">done</span>
                <span class="material-icons">close</span>
            </div>
            <div class="friend_request">
                <span class="material-icons">account_circle</span>
                <h4>Laplace</h4>
                <span class="material-icons">done</span>
                <span class="material-icons">close</span>
            </div>
            <div class="friend_request">
                <span class="material-icons">account_circle</span>
                <h4>Gauss</h4>
                <span class="material-icons">done</span>
                <span class="material-icons">close</span>
            </div>
        </div>

        <h2>Sent</h2>
        <div id="invite">
            <div class="request">
                <span class="material-icons">account_circle</span>
                <h4>John Smith</h4>
            </div>
            <div class="request">
                <span class="material-icons">account_circle</span>
                <h4>John Doe</h4>
            </div>
            <div class="request">
                <span class="material-icons">account_circle</span>
                <h4>Jane Doe</h4>
            </div>
        </div>

        <div id="nav"></div>
    </div>

    <!--Takes in a string and searches userdatabase for user names
    containing that string. If a user name contains that string,
    create a new div and append it to list of search results-->
    <script>
        function displayUsers(name) {

            var index = 1;

            db.collection("users")
                .get()
                .then((search) => {
                    search.forEach((doc) => {
                        var username = doc.data().name;

                        console.log(username);
                        console.log(typeof(username));
                        console.log(typeof(index));

                        if (username.includes(name)) {

                            var newDiv = document.createElement("div");
                            newDiv.id = index;
                            var newContent = document.createTextNode(username)
                            newDiv.appendChild(newContent);

                            var currentDiv = document.getElementById(String(index - 1));
                            index++;
                            var parentDiv = document.getElementById("container");
                            parentDiv.insertBefore(newDiv, currentDiv);
                        }
                    });
                });
        }
        displayUsers("t");
    </script>

    <!--Check if the current user has a record in the friends database. If not, initialize a record.
    Should probably be called when a new user signs up.
    -->
    <script>
        function populate() {

            firebase.auth().onAuthStateChanged(function(user) {

                if (user) {
                    var thisUser = firebase.auth().currentUser.uid;
                    console.log(thisUser);

                    db.collection("friends").doc(thisUser).get().then((data) => {
                        if (data.exists) {
                            console.log("Friends exists");
                        } else {
                            db.collection("friends").doc(thisUser).set({
                                thisUserid: thisUser
                            });
                            console.log("Friends don't exist");
                        }
                    })
                }
            })
        }
    </script>

    <!-- Sends the selected user a friend request 
    intended -> user id of the person
    -->
    <script>
        function sendFriendRequest(intended) {

            firebase.auth().onAuthStateChanged(function(user) {

                if (user) {
                    var thisUser = firebase.auth().currentUser.uid;
                    console.log(thisUser);

                    // db.collection("friends").doc(thisUser)
                    //   .collection("out_going_requests").doc("0WjpGj2E6MYIQG4Qc0TwyqNQlLk2").set({
                    //     id_requested: "0WjpGj2E6MYIQG4Qc0TwyqNQlLk2"
                    //   })

                    db.collection("friends").doc(thisUser).collection("outgoing_requests").doc(intended).get().then((data) => {
                        if (data.exists) {
                            console.log("You've already sent this person a friend request");
                        } else {
                            db.collection("friends").doc(thisUser).collection("outgoing_requests")
                                .doc(intended).set({
                                    id_requested: intended,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                })
                            db.collection("friends").doc(intended).collection("incoming_requests")
                                .doc(thisUser).set({
                                    incoming_id: thisUser,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                })
                        }
                    })
                }
            })
        }
    </script>

    <!-- Rejects the sent friend request
      intended -> the user id of person who sent the friend request
     -->
    <script>
        function rejectFriendRequest(intended) {
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    var thisUser = firebase.auth().currentUser.uid;
                    console.log(thisUser);

                    db.collection("friends").doc(thisUser).collection("incoming_requests").doc(intended).get().then((data) => {
                        if (!data.exists) {
                            console.log("Strange. No friend requests");
                        } else {
                            db.collection("friends").doc(thisUser).collection("incoming_requests")
                                .doc(intended).delete();
                            console.log("Removed incoming request");

                            db.collection("friends").doc(intended).collection("outgoing_requests")
                                .doc(thisUser).delete();
                            console.log("Removed outgoing request");
                        }
                    })
                }
            })
        }
    </script>

    <!--Gets the list of pending friend requests that the user has -->
    <script>
        function getPendingFriendRequests() {

            firebase.auth().onAuthStateChanged(function(user) {

                if (user) {
                    var thisUser = firebase.auth().currentUser.uid;
                    console.log(thisUser);
                }
            })
        }
    </script>

    <!-- Gets the list of friend requests that the user has sent -->
    <script>
        function getSentFriendRequests() {

        }
    </script>

    <!--------------------------------------------------->
    <!-- Your Javascript Libraries and scripts go here -->
    <!--------------------------------------------------->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</body>

</html>
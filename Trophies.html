<!DOCTYPE html>
<html lang="en">

<head>
    <title>Trophies</title>

    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />

    <!-- Firebase 8 CDNs-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <!-- Link to the api keys for your firebase project -->
    <script src="./scripts/firebaseAPI_TEAM23.js"></script>

    <!--Custom CSS-->
    <style>
        #profile_icon {
            position: absolute;
            font-size: 60px;
            margin-top: 10%;
            right: 5%;
            color: black;
            text-decoration: none;
        }
        
        body {
            margin-bottom: 10%;
        }
        
        .heading {
            margin-top: 10vh;
        }
        
        .list-group-item {
            display: flex;
            align-items: center;
        }
    </style>

    <!-- Google Icons (Material Design)-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
    <script>
        $.get("nav.html", {}, function(response) {
            $("div#nav").append(response);
        });
    </script>

    <!--HTML Portion-->
    <div class="container" id="container">
        <section class="heading">
            <h1>My Trophies <span id="number" class="badge bg-secondary">0</span></h1>
        </section>
        <br>
        <div id="have">
            <h3>Achieved Trophies</h3>
            <div id="1"></div>
        </div>
        <br>
        <div id="havenot">
            <h3>Not Yet Obtained</h3>
            <div id="-1"></div>
        </div>

        <div id="nav"></div>

        <!--Initialization of trophy database-->
        <script>
            function writeTrophies() {
                var trophyRef = db.collection("trophies");

                trophyRef.doc("New Beginning").set({
                    name: "New Beginning",
                    number_earned: 0,
                    points_required: 0,
                    description: "The start of a new you.",
                });
                trophyRef.doc("5 Day Streak").set({
                    name: "5 Day Streak",
                    number_earned: 0,
                    points_required: 5,
                    description: "Log in 5 days in a row.",
                });
                trophyRef.doc("10 Day Streak").set({
                    name: "10 Day Streak",
                    number_earned: 0,
                    points_required: 10,
                    description: "Log in 10 days in a row.",
                });
                trophyRef.doc("30 Day Streak").set({
                    name: "30 Day Streak",
                    number_earned: 0,
                    points_required: 30,
                    description: "Log in 30 days in a row.",
                });
            }
            //writeTrophies();

            // // test whether a document exists
            // var docRef = db
            //   .collection("trophies_achieved")
            //   .doc("bddW2OH9qXaR7jVuaKdUbnVLAIV2");
            // docRef
            //   .get()
            //   .then(function (doc) {
            //     if (doc.exists) {
            //       console.log("Document data:", doc.data());
            //     } else {
            //       console.log("No such document!");
            //     }
            //   })
            //   .catch(function (error) {
            //     console.log("Error getting document:", error);
            //   });

            /**
             * trophies_achieved database
             * name of trophy
             * time trophy was achieved
             */

            // console.log(firebase.auth().currentUser.getUid());
            console.log(firebase.auth());

            firebase.auth().onAuthStateChanged(function(user) {

                var timestamp = firebase.firestore.FieldValue.serverTimestamp();
                console.log(timestamp);
                var timestamp2 = new Date(timestamp);
                console.log(timestamp2);

                console.log(firebase.auth().currentUser.uid);
                if (user) {
                    var achievedDb = db.collection("trophies_achieved");

                    var thisUser = firebase.auth().currentUser.uid;
                    console.log(thisUser + " => test2");
                    console.log(typeof thisUser);

                    if (
                        achievedDb
                        .doc(thisUser)
                        .get()
                        .then((doc) => {
                            console.log(doc.id + " => doc id");

                            achievedDb
                                .doc(thisUser)
                                .get()
                                .then((docData) => {

                                    console.log(doc.id + " Check if this exists");

                                    // if (
                                    achievedDb
                                        .doc(thisUser)
                                        .get()
                                        .then((work) => {
                                            if (work.exists) {
                                                console.log("Working!");
                                                console.log(work.data());
                                            } else {
                                                console.log(
                                                    "This data definitely does not exist. One step further away."
                                                );

                                                // trophies_achieved -> user_id -> trophy_name -> achieved: boolean
                                                var addTrophies = db
                                                    .collection("trophies_achieved")
                                                    .doc(thisUser);

                                                // add field to make sure that document can be found
                                                addTrophies.set({
                                                    id: thisUser
                                                });

                                                var trophiesList = db.collection("trophies");

                                                trophiesList.get().then(function(querySnapshot) {
                                                    querySnapshot.forEach(function(temp) {
                                                        console.log(temp.id, " => ", temp.data());

                                                        console.log(temp.id);
                                                        console.log(
                                                            temp.data().description + " => description"
                                                        );

                                                        addTrophies
                                                            .collection("trophy_names")
                                                            .doc(temp.id)
                                                            .set({
                                                                achieved: false,
                                                            });
                                                    });
                                                });
                                            }
                                        })
                                });
                        })
                    );
                }
            });
        

        function displayGotten() {
          var number = 0;
          var index = 1;
          var location = -1;

          firebase.auth().onAuthStateChanged(function (user) {
            var thisUser = firebase.auth().currentUser.uid;

            console.log("The current user id is: " + thisUser);

            db.collection("trophies_achieved")
              .doc(thisUser)
              .collection("trophy_names")
              .get()
              .then((results) => {
                results.forEach((doc) => {
                  console.log(results);

                  var trophyName = doc.id;
                  console.log("Trophy name is: " + trophyName);

                  var achieved = doc.data().achieved;
                  console.log(achieved);

                  var newDiv = document.createElement("div");

                  if(achieved === true){
                    newDiv.id = index;
                  } else {
                    newDiv.id = location;
                  }

                  // newDiv.id = index;
                  newDiv.className = "trophy";
                  var name = document.createTextNode(trophyName);
                  newDiv.appendChild(name);

                  var spam = document.createElement("span");
                  spam.id = trophyName;
                  spam.className = "material-icons";
                  spam.innerHTML = "<span>" + "emoji_events" + "</span>";
                  newDiv.appendChild(spam);

                  // whether user has gotten that trophy or not
                  // var newContent = document.createTextNode(trophyName + ": ");
                  // newDiv.appendChild(newContent);
                  // var moreContent = document.createTextNode(achieved);
                  // newDiv.appendChild(moreContent);

                  var desc = "";
                  
                  db.collection("trophies").doc(trophyName).get().then((info) => {
                    console.log(info.data().description + " => trophy description");
                    console.log(typeof(info.data().description));
                    desc += info.data().description;

                    // Only works when inside this function?
                    var evenMore = document.createTextNode(desc);
                    var addspace = document.createElement("br");
                    newDiv.appendChild(addspace);
                    newDiv.appendChild(evenMore);
                  });

                  if(achieved === false){
                    var currentDiv = document.getElementById(String(location));
                    location--;
                    var parentDiv = document.getElementById("havenot");
                    parentDiv.insertBefore(newDiv, currentDiv);
                  } else {
                    var currentDiv = document.getElementById(String(index));
                    index++;
                    var parentDiv = document.getElementById("have");
                    parentDiv.insertBefore(newDiv, currentDiv);
                    number++;
                  }

                  document.getElementById("number").innerHTML = number;

                  // var currentDiv = document.getElementById(String(index - 1));
                  // index++;
                  // var parentDiv = document.getElementById("container");
                  // parentDiv.insertBefore(newDiv, currentDiv);

                                // if (achieved === false) {
                                //     var currentDiv = document.getElementById(String(location));
                                //     location--;
                                //     var parentDiv = document.getElementById("havenot");
                                //     parentDiv.insertBefore(newDiv, currentDiv);
                                // } else {
                                //     var currentDiv = document.getElementById(String(index));
                                //     index++;
                                //     var parentDiv = document.getElementById("have");
                                //     parentDiv.insertBefore(newDiv, currentDiv);
                                //     number++;
                                // }

                                // document.getElementById("number").innerHTML = number;

                                // var currentDiv = document.getElementById(String(index - 1));
                                // index++;
                                // var parentDiv = document.getElementById("container");
                                // parentDiv.insertBefore(newDiv, currentDiv);

                            });
                        });
                });
            }

            displayGotten();
            displayTrophy();
        </script>
    </div>

    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    -->
</body>

</html>